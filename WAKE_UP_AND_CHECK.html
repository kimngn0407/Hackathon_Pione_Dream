<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Wake Up Backend & Check</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .alert-danger {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .alert-success {
            background: #d1e7dd;
            border-left: 4px solid #28a745;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: block;
            margin: 20px auto;
            min-width: 250px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #progress {
            margin: 30px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.8;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-warning { color: #fbbf24; }
        .log-info { color: #60a5fa; }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• ƒê√°nh Th·ª©c Backend & Ki·ªÉm Tra</h1>
        
        <div class="alert">
            <strong>‚ö†Ô∏è Railway Free Tier:</strong> Backend s·∫Ω t·ª± ƒë·ªông ng·ªß sau 5 ph√∫t kh√¥ng ho·∫°t ƒë·ªông. Tool n√†y s·∫Ω t·ª± ƒë·ªông ƒë√°nh th·ª©c backend v√† ki·ªÉm tra database!
        </div>

        <button onclick="startWakeUpAndCheck()" id="startBtn">üöÄ B·∫Øt ƒê·∫ßu</button>

        <div id="progress">
            <p id="statusText">ƒêang x·ª≠ l√Ω...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
        </div>

        <div id="log"></div>
    </div>

    <script>
        const API_BASE = 'https://hackathonpionedream-production.up.railway.app';
        let progressPercent = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            let className = 'log-' + type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(percent, text) {
            progressPercent = percent;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('statusText').textContent = text;
        }

        async function startWakeUpAndCheck() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('progress').style.display = 'block';
            document.getElementById('log').innerHTML = '';

            log('üî• B·∫Øt ƒë·∫ßu ƒë√°nh th·ª©c backend...', 'info');
            updateProgress(10, 'üî• ƒêang ƒë√°nh th·ª©c backend...');

            // Step 1: Wake up backend
            const isAwake = await wakeUpBackend();
            
            if (!isAwake) {
                log('‚ùå Kh√¥ng th·ªÉ ƒë√°nh th·ª©c backend!', 'error');
                log('', 'error');
                log('üí° GI·∫¢I PH√ÅP:', 'warning');
                log('1. Ki·ªÉm tra Railway Dashboard xem backend c√≥ running kh√¥ng', 'warning');
                log('2. Th·ª≠ m·ªü tr·ª±c ti·∫øp: ' + API_BASE + '/actuator/health', 'warning');
                log('3. ƒê·ª£i 1-2 ph√∫t r·ªìi th·ª≠ l·∫°i', 'warning');
                document.getElementById('startBtn').disabled = false;
                updateProgress(0, '‚ùå Th·∫•t b·∫°i');
                return;
            }

            updateProgress(40, '‚úÖ Backend ƒë√£ th·ª©c! ƒêang login...');

            // Step 2: Login and get token
            const token = await loginAndGetToken();
            
            if (!token) {
                log('‚ùå Kh√¥ng th·ªÉ login!', 'error');
                document.getElementById('startBtn').disabled = false;
                updateProgress(40, '‚ùå Login th·∫•t b·∫°i');
                return;
            }

            updateProgress(50, '‚úÖ Login th√†nh c√¥ng! ƒêang ki·ªÉm tra database...');

            // Step 3: Check all data
            await checkAllData(token);

            updateProgress(100, '‚úÖ Ho√†n th√†nh!');
            document.getElementById('startBtn').disabled = false;
            log('', 'info');
            log('üéâ ƒê√£ ho√†n th√†nh ki·ªÉm tra!', 'success');
        }

        async function wakeUpBackend() {
            const maxRetries = 10;
            const retryDelay = 5000; // 5 seconds

            for (let i = 1; i <= maxRetries; i++) {
                try {
                    log(`üîÑ Th·ª≠ k·∫øt n·ªëi l·∫ßn ${i}/${maxRetries}...`, 'info');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(`${API_BASE}/actuator/health`, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'UP') {
                            log(`‚úÖ Backend ƒë√£ th·ª©c! Status: ${data.status}`, 'success');
                            return true;
                        }
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        log(`   ‚è±Ô∏è Timeout, ƒëang ch·ªù backend kh·ªüi ƒë·ªông...`, 'warning');
                    } else {
                        log(`   ‚ö†Ô∏è ${error.message}`, 'warning');
                    }
                }

                if (i < maxRetries) {
                    log(`   ‚è≥ ƒê·ª£i ${retryDelay/1000}s tr∆∞·ªõc khi th·ª≠ l·∫°i...`, 'info');
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                    updateProgress(10 + (i * 3), `ƒêang ƒë√°nh th·ª©c... (${i}/${maxRetries})`);
                }
            }

            return false;
        }

        async function loginAndGetToken() {
            log('', 'info');
            log('üîê ƒêang login...', 'info');
            
            const accounts = [
                { email: 'admin@smartfarm.com', password: 'admin123' },
                { email: 'admin@test.com', password: 'admin123' }
            ];

            for (const account of accounts) {
                try {
                    log(`   üîë Th·ª≠ login v·ªõi ${account.email}...`, 'info');
                    
                    const response = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(account)
                    });

                    const data = await response.json();
                    
                    if (response.ok && data.success && data.token) {
                        log(`   ‚úÖ Login th√†nh c√¥ng!`, 'success');
                        log(`   üé´ Token: ${data.token.substring(0, 30)}...`, 'info');
                        return data.token;
                    } else {
                        log(`   ‚ö†Ô∏è Th·∫•t b·∫°i: ${data.error || 'Unknown error'}`, 'warning');
                    }
                } catch (error) {
                    log(`   ‚ö†Ô∏è Error: ${error.message}`, 'warning');
                }
            }

            return null;
        }

        async function checkAllData(token) {
            log('', 'info');
            log('üìä B·∫Øt ƒë·∫ßu ki·ªÉm tra database...', 'info');
            log('', 'info');

            const endpoints = [
                { name: 'FARMS', url: '/api/farms', icon: 'üè°', percent: 60 },
                { name: 'FIELDS', url: '/api/fields', icon: 'üåæ', percent: 70 },
                { name: 'SENSORS', url: '/api/sensors', icon: 'üì°', percent: 80 },
                { name: 'PLANTS', url: '/api/plants', icon: 'üå±', percent: 90 }
            ];

            let summary = [];

            for (const endpoint of endpoints) {
                updateProgress(endpoint.percent, `ƒêang ki·ªÉm tra ${endpoint.name}...`);
                const result = await checkEndpoint(endpoint, token);
                summary.push(result);
            }

            // Print summary
            log('', 'info');
            log('=' .repeat(50), 'info');
            log('üìã T√ìM T·∫ÆT K·∫æT QU·∫¢:', 'info');
            log('=' .repeat(50), 'info');
            
            for (const result of summary) {
                if (result.isArray && result.count > 0) {
                    log(`${result.icon} ${result.name}: ‚úÖ ${result.count} records`, 'success');
                } else if (result.isArray && result.count === 0) {
                    log(`${result.icon} ${result.name}: ‚ö†Ô∏è TABLE EMPTY!`, 'warning');
                } else {
                    log(`${result.icon} ${result.name}: ‚ùå NOT AN ARRAY!`, 'error');
                }
            }

            log('=' .repeat(50), 'info');

            // Check if we need to create data
            const allEmpty = summary.every(r => r.count === 0);
            if (allEmpty) {
                log('', 'info');
                log('üö® T·∫§T C·∫¢ TABLES ƒê·ªÄU TR·ªêNG!', 'error');
                log('', 'error');
                log('üí° GI·∫¢I PH√ÅP:', 'warning');
                log('1. M·ªü: http://localhost:8000/CREATE_TEST_DATA_NO_IMPORT.html', 'warning');
                log('2. Login v·ªõi admin account', 'warning');
                log('3. Click "T·∫°o 3 Farms"', 'warning');
                log('4. Click "T·∫°o 5 Fields"', 'warning');
                log('5. Click "T·∫°o 10 Sensors"', 'warning');
                log('6. Click "T·∫°o 3 Plants"', 'warning');
            }
        }

        async function checkEndpoint(endpoint, token) {
            log(`${endpoint.icon} Checking ${endpoint.name}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}${endpoint.url}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                log(`   üìä Status: ${response.status}`, 'info');
                log(`   üì¶ Type: ${typeof data}`, 'info');
                log(`   üì¶ Is Array: ${Array.isArray(data)}`, 'info');
                
                if (Array.isArray(data)) {
                    log(`   ‚úÖ Count: ${data.length}`, data.length > 0 ? 'success' : 'warning');
                    
                    if (data.length > 0) {
                        log(`   üìù Sample:`, 'info');
                        log(`   ${JSON.stringify(data[0], null, 2)}`, 'info');
                    } else {
                        log(`   ‚ö†Ô∏è TABLE IS EMPTY!`, 'warning');
                    }

                    return {
                        name: endpoint.name,
                        icon: endpoint.icon,
                        isArray: true,
                        count: data.length
                    };
                } else {
                    log(`   ‚ùå NOT AN ARRAY!`, 'error');
                    log(`   Data: ${JSON.stringify(data)}`, 'error');
                    
                    return {
                        name: endpoint.name,
                        icon: endpoint.icon,
                        isArray: false,
                        count: 0
                    };
                }
            } catch (error) {
                log(`   ‚ùå Error: ${error.message}`, 'error');
                return {
                    name: endpoint.name,
                    icon: endpoint.icon,
                    isArray: false,
                    count: 0
                };
            }
            
            log('', 'info');
        }
    </script>
</body>
</html>


